<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <title>Mortgage Calculator with AI Insights - ZenCalcs</title>
    <meta name="description" content="Smart mortgage calculator with AI-powered insights, scenario analysis, and personalized recommendations. Calculate payments and get expert guidance.">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMJ87N3YC3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-YMJ87N3YC3');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* Typography */
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #F8F9FA; min-height: 100vh; color: #2D3748; }

        /* Navigation */
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px 30px; position: sticky; top: 0; z-index: 1000; }
        .nav-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { height: 40px; width: auto; }
        .nav-right { display: flex; gap: 20px; align-items: center; }
        .search-box { display: flex; align-items: center; background: #FFFFFF; border: 1px solid #E5E7EB; border-radius: 8px; padding: 8px 16px; min-width: 250px; transition: all 0.3s ease; }
        .search-box:hover { border-color: #2C5F6F; }
        .search-box:focus-within { border-color: #2C5F6F; box-shadow: 0 0 0 3px rgba(44, 95, 111, 0.1); }
        .search-box svg { width: 20px; height: 20px; color: #6B7280; margin-right: 10px; }
        .search-box input { border: none; outline: none; background: transparent; flex: 1; color: #2D3748; font-size: 0.95em; }
        .search-box input::placeholder { color: #D1D5DB; }
        .hamburger { display: flex; flex-direction: column; gap: 5px; cursor: pointer; padding: 5px; }
        .hamburger span { width: 28px; height: 3px; background: #2C5F6F; border-radius: 3px; transition: all 0.3s ease; }
        .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(8px, 8px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(7px, -7px); }
        .mobile-menu { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.5); z-index: 999; }
        .mobile-menu.active { display: block; }
        .mobile-menu-content { position: fixed; top: 0; right: -350px; width: 320px; height: 100vh; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; padding: 80px 20px 20px 20px; overflow-y: auto; }
        .mobile-menu.active .mobile-menu-content { right: 0; }
        .search-container { padding: 10px 15px 20px; }
        .search-input { width: 100%; padding: 12px 15px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1em; }
        .search-input:focus { outline: none; border-color: #2C5F6F; box-shadow: 0 0 0 3px rgba(44, 95, 111, 0.1); }
        .category-header { font-size: 0.9em; font-weight: 700; color: #6B7280; padding: 15px 20px 10px; text-transform: uppercase; letter-spacing: 1px; }
        .category-divider { height: 1px; background: #E5E7EB; margin: 10px 0; }
        .mobile-menu-item { padding: 14px 20px; margin-bottom: 5px; background: #F8F9FA; border-radius: 8px; font-size: 0.95em; font-weight: 500; color: #2C5F6F; text-decoration: none; display: block; transition: all 0.3s ease; border-left: 4px solid transparent; }
        .mobile-menu-item:hover { background: #E0F2F1; border-left-color: #2C5F6F; transform: translateX(-5px); }
        .mobile-menu-item.placeholder { opacity: 0.5; cursor: not-allowed; }
        .mobile-menu-item.placeholder:hover { transform: none; }

        /* Main Container */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        /* Page Header */
        .page-header { text-align: center; margin-bottom: 40px; }
        .page-header h1 { color: #2D3748; font-size: 2.5em; margin-bottom: 10px; }
        .page-header p { color: #6B7280; font-size: 1.1em; }

        /* Two-Column Layout */
        .calculator-grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 2rem; margin-bottom: 30px; align-items: flex-start; }

        /* Left Column - Inputs */
        .inputs-section { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); height: fit-content; position: sticky; top: 100px; border: 1px solid #E5E7EB; }
        .inputs-section h2 { color: #2D3748; font-size: 1.5em; margin-bottom: 8px; }
        .inputs-section .subtitle { color: #6B7280; font-size: 0.95em; margin-bottom: 30px; line-height: 1.6; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #4B5563; font-size: 1em; }
        .input-group input { width: 100%; min-height: 44px; padding: 12px 14px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1em; transition: all 0.3s ease; }
        .input-group input:focus { outline: none; border-color: #2C5F6F; box-shadow: 0 0 0 3px rgba(44, 95, 111, 0.1); }
        .input-divider { height: 1px; background: #E5E7EB; margin: 30px 0; }
        .calculate-btn { width: 100%; min-height: 50px; padding: 14px 18px; background: linear-gradient(135deg, #2C5F6F 0%, #1E40AF 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; box-shadow: 0 4px 15px rgba(44, 95, 111, 0.3); }
        .calculate-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(44, 95, 111, 0.4); }

        /* Right Column - Results */
        .results-section { background: #FAFAFA; border-radius: 20px; padding: 40px; border: 1px solid #E5E7EB; min-height: 400px; display: flex; align-items: center; justify-content: center; }
        .results-section.has-results { display: block; align-items: flex-start; background: transparent; border: none; padding: 0; }
        .results-calculated { display: none; transition: all 0.4s ease-in-out; }
        .results-calculated.active { display: block; animation: fadeInUp 0.4s ease-in-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Placeholder State */
        .placeholder-state { text-align: center; padding: 40px 30px; max-width: 480px; margin: 0 auto; transition: all 0.4s ease-in-out; }
        .placeholder-state.hidden { opacity: 0; transform: translateY(-20px); pointer-events: none; display: none; }
        .placeholder-icon { width: 80px; height: 80px; margin: 0 auto 25px; opacity: 0.7; }
        .placeholder-icon svg { width: 100%; height: 100%; }
        .placeholder-state h3 { color: #2D3748; font-size: 1.5em; margin-bottom: 15px; font-weight: 600; }
        .placeholder-state p { color: #6B7280; font-size: 1em; line-height: 1.7; margin-bottom: 30px; }
        .ai-preview-hint { background: white; padding: 20px; border-radius: 12px; border: 1px solid #E5E7EB; margin-top: 20px; display: flex; align-items: flex-start; gap: 15px; text-align: left; }
        .ai-preview-hint svg { width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px; }
        .ai-preview-hint p { color: #4B5563; font-weight: 400; margin: 0; font-size: 0.95em; line-height: 1.6; }

        /* Card Styles */
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .card h3 { color: #2D3748; font-size: 1.5em; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        /* What This Means Card */
        .what-this-means { background: linear-gradient(135deg, #F0FDF4 0%, #ECFDF5 100%); border: 2px solid #86EFAC; margin-bottom: 25px; }
        .what-this-means h3 { color: #166534; font-size: 1.3em; }
        .what-this-means h3::before { content: ""; display: inline-block; width: 6px; height: 6px; background: #22C55E; border-radius: 50%; margin-right: 10px; }

        /* Section 1: Mortgage Summary */
        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        .metric-card { background: #F8F9FA; padding: 20px; border-radius: 12px; border-left: 4px solid #2C5F6F; }
        .metric-label { font-size: 0.9em; color: #6B7280; margin-bottom: 8px; font-weight: 600; }
        .metric-value { font-size: 1.8em; font-weight: 700; color: #2C5F6F; }
        .chart-container { background: #F8F9FA; padding: 20px; border-radius: 12px; margin-top: 20px; height: 300px; }

        /* Section 2: AI Insights */
        .ai-insights-card { background: linear-gradient(135deg, #EEF2FF 0%, #E0F2FE 100%); border: 1px solid #BFDBFE; }
        .ai-insights-content { color: #1E293B; line-height: 1.8; }
        .ai-insights-content p { margin-bottom: 15px; }
        .ai-loading { text-align: center; padding: 30px; color: #6B7280; font-size: 0.95em; }
        .ai-loading::before { content: ""; display: block; width: 40px; height: 40px; margin: 0 auto 15px; border: 3px solid #E5E7EB; border-top-color: #2C5F6F; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Section 3: Interactive AI Tools */
        .ai-tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px; }
        .ai-tool-btn { background: white; border: 2px solid #E5E7EB; padding: 15px 20px; border-radius: 12px; font-size: 0.95em; font-weight: 600; color: #2C5F6F; cursor: pointer; transition: all 0.3s ease; text-align: left; display: flex; align-items: center; gap: 10px; }
        .ai-tool-btn:hover { border-color: #2C5F6F; background: #F8F9FA; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(44, 95, 111, 0.15); }
        .ai-tool-btn:active { transform: translateY(0); }

        /* AI Response Area */
        .ai-response-area { margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #E5E7EB; display: none; }
        .ai-response-area.active { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .ai-response-area h4 { color: #2C5F6F; margin-bottom: 12px; font-size: 1.1em; }
        .ai-response-area p { color: #4B5563; line-height: 1.7; }

        /* Section 4: Amortization Schedule */
        .table-wrapper { width: 100%; overflow-x: auto; margin-top: 20px; -webkit-overflow-scrolling: touch; }
        .table-wrapper::-webkit-scrollbar { height: 8px; }
        .table-wrapper::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-wrapper::-webkit-scrollbar-thumb { background: #2C5F6F; border-radius: 10px; }
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        .data-table thead { background: #2C5F6F; color: white; }
        .data-table th, .data-table td { padding: 16px; text-align: left; border-bottom: 1px solid #E5E7EB; white-space: nowrap; }
        .data-table th { font-weight: 700; }
        .data-table tbody tr { transition: background 0.2s ease; }
        .data-table tbody tr:hover { background: #F8F9FA; }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .ai-observation { margin-top: 20px; padding: 20px; background: #F0F9FF; border-radius: 12px; border-left: 4px solid #0EA5E9; }
        .ai-observation p { color: #0C4A6E; line-height: 1.7; }

        /* Sticky Calculate Button (Mobile) */
        .sticky-calculate-wrapper { display: none; }

        /* Responsive */
        @media (max-width: 1024px) {
            .calculator-grid { grid-template-columns: 1fr; gap: 20px; }
            .inputs-section { position: static; }
            .metrics-grid { grid-template-columns: 1fr; }
            .ai-tools-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .navbar { padding: 10px 15px; }
            .logo { height: 32px; }
            .page-header h1 { font-size: 2em; }
            .card { padding: 20px; }
            .chart-container { height: 250px; }

            /* Show sticky button on mobile */
            .sticky-calculate-wrapper { display: block; position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); z-index: 100; }
            .inputs-section .calculate-btn { display: none; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">
                <img src="50F4465B-4D0A-459B-AAD8-B367AAEEF636.jpg" alt="ZenCalcs Logo" class="logo">
            </a>

            <div class="nav-right">
                <div class="search-box" onclick="openSearchInMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" placeholder="Search Calculator" readonly onclick="openSearchInMenu()">
                </div>
                <div class="hamburger" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Slide-out Menu (keeping existing menu) -->
    <div class="mobile-menu" id="mobileMenu" onclick="closeMobileMenu()">
        <div class="mobile-menu-content" onclick="event.stopPropagation()">
            <!-- Search Bar -->
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search calculators..." onkeyup="filterCalculators()">
            </div>

            <!-- AI Calculator -->
            <a href="index.html" class="mobile-menu-item" style="background: linear-gradient(135deg, #2C5F6F 0%, #1E40AF 100%); color: white; font-weight: 700; border-left-color: #1E40AF; box-shadow: 0 4px 12px rgba(44, 95, 111, 0.3); margin-bottom: 15px;">⚡ AI Calculator Assistant</a>

            <div class="category-divider"></div>

            <!-- Financial Calculators -->
            <div class="category-header">Financial</div>
            <a href="mortgage-calculator.html" class="mobile-menu-item">Mortgage Calculator</a>
            <a href="loan-calculator.html" class="mobile-menu-item">Loan Calculator</a>
            <a href="auto-loan-calculator.html" class="mobile-menu-item">Auto Loan Calculator</a>
            <a href="compound-interest.html" class="mobile-menu-item">Savings Calculator</a>
            <a href="payment-calculator.html" class="mobile-menu-item">Payment Calculator</a>
            <a href="retirement-calculator.html" class="mobile-menu-item">Retirement Calculator</a>
            <a href="amortization-calculator.html" class="mobile-menu-item">Amortization Calculator</a>
            <a href="investment-calculator.html" class="mobile-menu-item">Investment Calculator</a>
            <a href="inflation-calculator.html" class="mobile-menu-item">Inflation Calculator</a>
            <a href="roi-calculator.html" class="mobile-menu-item">ROI Calculator</a>
            <a href="savings-calculator.html" class="mobile-menu-item">Income Tax Calculator</a>

            <div class="category-divider"></div>

            <!-- Fitness & Health -->
            <div class="category-header">Fitness & Health</div>
            <a href="bmi-calculator.html" class="mobile-menu-item">BMI Calculator</a>
            <a href="calorie-calculator.html" class="mobile-menu-item">Calorie Calculator</a>
            <a href="body-fat-calculator.html" class="mobile-menu-item">Body Fat Calculator</a>
            <a href="bmr-calculator.html" class="mobile-menu-item">BMR Calculator</a>
            <a href="ideal-weight-calculator.html" class="mobile-menu-item">Ideal Weight Calculator</a>
            <a href="pace-calculator.html" class="mobile-menu-item">Pace Calculator</a>
            <a href="pregnancy-calculator.html" class="mobile-menu-item">Pregnancy Calculator</a>
            <a href="due-date-calculator.html" class="mobile-menu-item">Due Date Calculator</a>
            <a href="macro-calculator.html" class="mobile-menu-item">Macro Calculator</a>
            <a href="body-type-calculator.html" class="mobile-menu-item">Body Type Calculator</a>

            <div class="category-divider"></div>

            <!-- Math Calculators -->
            <div class="category-header">Math</div>
            <a href="scientific-calculator.html" class="mobile-menu-item">Scientific Calculator</a>
            <a href="fraction-calculator.html" class="mobile-menu-item">Fraction Calculator</a>
            <a href="percentage-calculator.html" class="mobile-menu-item">Percentage Calculator</a>
            <a href="random-number-generator.html" class="mobile-menu-item">Random Number Generator</a>
            <a href="triangle-calculator.html" class="mobile-menu-item">Triangle Calculator</a>
            <a href="standard-deviation-calculator.html" class="mobile-menu-item">Standard Deviation Calculator</a>
            <a href="square-root-calculator.html" class="mobile-menu-item">Square Root Calculator</a>
            <a href="exponent-calculator.html" class="mobile-menu-item">Exponent Calculator</a>
            <a href="log-calculator.html" class="mobile-menu-item">Log Calculator</a>
            <a href="algebra-calculator.html" class="mobile-menu-item">Algebra Calculator</a>

        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1>Mortgage Calculator with AI Insights</h1>
            <p>Smart mortgage analysis with personalized AI guidance and scenario planning</p>
        </div>

        <div class="calculator-grid">
            <!-- Left Column: Inputs -->
            <div class="inputs-section">
                <h2>Mortgage Details</h2>
                <p class="subtitle">Estimate your monthly payments and total interest.</p>

                <div class="input-group">
                    <label>Home Price ($)</label>
                    <input type="number" id="homePrice" value="300000" min="0">
                </div>

                <div class="input-group">
                    <label>Down Payment ($)</label>
                    <input type="number" id="downPayment" value="60000" min="0">
                </div>

                <div class="input-group">
                    <label>Interest Rate (%)</label>
                    <input type="number" id="interestRate" value="6.5" step="0.1" min="0" max="30">
                </div>

                <div class="input-group">
                    <label>Loan Term (years)</label>
                    <input type="number" id="loanTerm" value="30" min="1" max="40">
                </div>

                <button class="calculate-btn" onclick="calculateMortgage()">Calculate Mortgage</button>
            </div>

            <!-- Right Column: Results & AI Insights -->
            <div class="results-section" id="resultsSection">
                <!-- Placeholder State (Before Calculation) -->
                <div class="card placeholder-state" id="placeholderState">
                    <div class="placeholder-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #2C5F6F;">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                            <line x1="7" y1="7" x2="7" y2="11"></line>
                            <line x1="12" y1="7" x2="12" y2="11"></line>
                            <line x1="17" y1="7" x2="17" y2="11"></line>
                        </svg>
                    </div>
                    <h3>Ready when you are!</h3>
                    <p>Enter your mortgage details on the left to see comprehensive analysis with charts, payment breakdown, and AI-powered insights instantly.</p>

                    <div class="ai-preview-hint">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #2C5F6F;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p><strong>ZenCalcs AI will help you:</strong> Explain what affects your results, compare different scenarios, and provide personalized recommendations to optimize your mortgage.</p>
                    </div>
                </div>

                <!-- Results State (After Calculation) -->
                <div class="results-calculated" id="resultsCalculated">
                    <!-- What This Means Card -->
                    <div class="card what-this-means" id="whatThisMeans">
                        <h3>What This Means</h3>
                        <div id="summaryText">
                            <div class="ai-loading">Generating summary...</div>
                        </div>
                    </div>

                    <!-- Section 1: Mortgage Summary -->
                    <div class="card">
                        <h3>Your Mortgage Summary</h3>
                        <div class="metrics-grid" id="metricsGrid"></div>
                        <div class="chart-container">
                            <canvas id="mortgageChart"></canvas>
                        </div>
                    </div>

                    <!-- Section 2: ZenCalcs AI Insights -->
                    <div class="card ai-insights-card">
                        <h3>ZenCalcs AI Insights</h3>
                        <div class="ai-insights-content" id="aiInsights">
                            <div class="ai-loading">Analyzing your mortgage...</div>
                        </div>
                    </div>

                    <!-- Section 3: Interactive AI Tools -->
                    <div class="card">
                        <h3>Interactive AI Tools</h3>
                        <p style="color: #6B7280; margin-bottom: 15px; font-size: 0.95em;">Get personalized analysis based on your specific mortgage details:</p>
                        <div class="ai-tools-grid">
                            <button class="ai-tool-btn" onclick="handleAITool('explain')">
                                Explain My Result
                            </button>
                            <button class="ai-tool-btn" onclick="handleAITool('optimize')">
                                Optimize My Loan
                            </button>
                            <button class="ai-tool-btn" onclick="handleAITool('compare')">
                                Compare Term Options
                            </button>
                            <button class="ai-tool-btn" onclick="handleAITool('buyvsrent')">
                                Buy vs Rent Analysis
                            </button>
                        </div>
                        <div class="ai-response-area" id="aiResponseArea"></div>
                    </div>

                    <!-- Section 4: Amortization Schedule -->
                    <div class="card">
                        <h3>Amortization Schedule</h3>
                        <div class="table-wrapper">
                            <table class="data-table" id="amortizationTable"></table>
                        </div>
                        <div class="ai-observation" id="aiObservation"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Calculate Button (Mobile) -->
        <div class="sticky-calculate-wrapper">
            <button class="calculate-btn" onclick="calculateMortgage()">Calculate Mortgage</button>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let currentMortgageData = null;

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            menu.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            menu.classList.remove('active');
            hamburger.classList.remove('active');
        }

        function openSearchInMenu() {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            menu.classList.add('active');
            hamburger.classList.add('active');
            setTimeout(() => {
                document.getElementById('searchInput').focus();
            }, 300);
        }

        function filterCalculators() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('.mobile-menu-item');
            const headers = document.querySelectorAll('.category-header');
            const dividers = document.querySelectorAll('.category-divider');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            if (searchTerm) {
                headers.forEach(header => header.style.display = 'none');
                dividers.forEach(divider => divider.style.display = 'none');
            } else {
                headers.forEach(header => header.style.display = 'block');
                dividers.forEach(divider => divider.style.display = 'block');
            }
        }

        async function calculateMortgage() {
            const homePrice = parseFloat(document.getElementById('homePrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            const rate = parseFloat(document.getElementById('interestRate').value) / 100 / 12;
            const term = parseFloat(document.getElementById('loanTerm').value) * 12;

            const loanAmount = homePrice - downPayment;
            const monthlyPayment = loanAmount * (rate * Math.pow(1 + rate, term)) / (Math.pow(1 + rate, term) - 1);
            const totalPaid = monthlyPayment * term;
            const totalInterest = totalPaid - loanAmount;
            const downPaymentPercent = (downPayment / homePrice) * 100;

            // Calculate amortization schedule
            let balance = loanAmount;
            let yearlyData = [];
            let yearPrincipal = 0;
            let yearInterest = 0;

            for (let i = 1; i <= term; i++) {
                const interestPayment = balance * rate;
                const principalPayment = monthlyPayment - interestPayment;
                balance -= principalPayment;

                yearPrincipal += principalPayment;
                yearInterest += interestPayment;

                if (i % 12 === 0 || i === term) {
                    yearlyData.push({
                        year: Math.ceil(i / 12),
                        principal: yearPrincipal,
                        interest: yearInterest,
                        balance: Math.max(0, balance),
                        equity: loanAmount - balance
                    });
                    yearPrincipal = 0;
                    yearInterest = 0;
                }
            }

            // Store current data for AI tools
            currentMortgageData = {
                homePrice,
                downPayment,
                interestRate: parseFloat(document.getElementById('interestRate').value),
                loanTerm: parseFloat(document.getElementById('loanTerm').value),
                monthlyPayment,
                totalInterest,
                totalPaid,
                loanAmount,
                yearlyData
            };

            // Display results
            displayResults(currentMortgageData);

            // Get AI insights
            await getAIInsights(currentMortgageData);

            // Update chat widget context with new calculation data
            updateChatContext();

            // Scroll to results
            setTimeout(() => {
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function displayResults(data) {
            // Hide placeholder, show results with animation
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('has-results');
            document.getElementById('placeholderState').classList.add('hidden');
            document.getElementById('resultsCalculated').classList.add('active');

            // Generate "What This Means" summary
            generateWhatThisMeans(data);

            // Section 1: Metrics Grid
            document.getElementById('metricsGrid').innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Monthly Payment</div>
                    <div class="metric-value">${formatCurrency(data.monthlyPayment)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Interest</div>
                    <div class="metric-value">${formatCurrency(data.totalInterest)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Paid</div>
                    <div class="metric-value">${formatCurrency(data.totalPaid)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Loan Amount</div>
                    <div class="metric-value">${formatCurrency(data.loanAmount)}</div>
                </div>
            `;

            // Chart
            createChart(data.yearlyData);

            // Section 4: Amortization Table
            document.getElementById('amortizationTable').innerHTML = `
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Principal Paid</th>
                        <th>Interest Paid</th>
                        <th>Total Paid</th>
                        <th>Remaining Balance</th>
                        <th>Equity Built</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.yearlyData.map(row => `
                        <tr>
                            <td><strong>Year ${row.year}</strong></td>
                            <td>${formatCurrency(row.principal)}</td>
                            <td>${formatCurrency(row.interest)}</td>
                            <td>${formatCurrency(row.principal + row.interest)}</td>
                            <td>${formatCurrency(row.balance)}</td>
                            <td>${formatCurrency(row.equity)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            // AI Observation
            generateAIObservation(data);
        }

        function createChart(yearlyData) {
            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = document.getElementById('mortgageChart');
            chartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: yearlyData.map(d => `Year ${d.year}`),
                    datasets: [
                        {
                            label: 'Principal',
                            data: yearlyData.map(d => d.principal),
                            backgroundColor: '#2C5F6F',
                            borderRadius: 6
                        },
                        {
                            label: 'Interest',
                            data: yearlyData.map(d => d.interest),
                            backgroundColor: '#5FA8D3',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: {
                            display: true,
                            text: 'Principal vs Interest Payments',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => context.dataset.label + ': ' + formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: (value) => '$' + (value / 1000).toFixed(0) + 'K'
                            }
                        }
                    }
                }
            });
        }

        async function getAIInsights(data) {
            const insightsDiv = document.getElementById('aiInsights');
            insightsDiv.innerHTML = '<div class="ai-loading">Analyzing your mortgage...</div>';

            try {
                const response = await fetch('/.netlify/functions/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Analyze this mortgage and provide 2-3 paragraphs of insights:

Home Price: ${formatCurrency(data.homePrice)}
Down Payment: ${formatCurrency(data.downPayment)} (${((data.downPayment/data.homePrice)*100).toFixed(1)}%)
Loan Amount: ${formatCurrency(data.loanAmount)}
Interest Rate: ${data.interestRate}%
Loan Term: ${data.loanTerm} years
Monthly Payment: ${formatCurrency(data.monthlyPayment)}
Total Interest: ${formatCurrency(data.totalInterest)}
Total Paid: ${formatCurrency(data.totalPaid)}

Explain what these numbers mean, highlight the interest proportion, and suggest one optimization.`
                    })
                });

                const result = await response.json();
                insightsDiv.innerHTML = `<div class="ai-insights-content">${result.response.replace(/\n/g, '<br><br>')}</div>`;
            } catch (error) {
                console.error('AI Insights error:', error);
                insightsDiv.innerHTML = '<p>Your monthly payment of ' + formatCurrency(data.monthlyPayment) + ' includes both principal and interest. Over ' + data.loanTerm + ' years, you\'ll pay ' + formatCurrency(data.totalInterest) + ' in interest (' + ((data.totalInterest/data.loanAmount)*100).toFixed(0) + '% of the loan amount). Consider increasing your down payment or choosing a shorter term to reduce total interest costs.</p>';
            }
        }

        async function generateWhatThisMeans(data) {
            const summaryDiv = document.getElementById('summaryText');
            summaryDiv.innerHTML = '<div class="ai-loading" style="padding: 15px;">Generating summary...</div>';

            try {
                const response = await fetch('/.netlify/functions/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Generate a concise 2-3 sentence plain-language summary of this mortgage:

Monthly Payment: ${formatCurrency(data.monthlyPayment)}
Total Interest: ${formatCurrency(data.totalInterest)}
Loan Term: ${data.loanTerm} years

Make it conversational and focus on what the user should know most. Start directly with the insight, no greeting.`
                    })
                });

                const result = await response.json();
                summaryDiv.innerHTML = `<p style="color: #166534; font-size: 1.05em; line-height: 1.8; margin: 0;">${result.response}</p>`;
            } catch (error) {
                console.error('What This Means error:', error);
                const interestPercent = ((data.totalInterest / data.loanAmount) * 100).toFixed(0);
                summaryDiv.innerHTML = `<p style="color: #166534; font-size: 1.05em; line-height: 1.8; margin: 0;">Your ${formatCurrency(data.monthlyPayment)} monthly payment stays the same for ${data.loanTerm} years. You'll pay ${formatCurrency(data.totalInterest)} in interest (${interestPercent}% of your loan amount), which is typical for a ${data.loanTerm}-year mortgage. Consider making extra payments to reduce this cost.</p>`;
            }
        }

        function generateAIObservation(data) {
            // Find when principal > interest
            let crossoverYear = data.yearlyData.length;
            for (let i = 0; i < data.yearlyData.length; i++) {
                if (data.yearlyData[i].principal > data.yearlyData[i].interest) {
                    crossoverYear = i + 1;
                    break;
                }
            }

            const finalYear = data.yearlyData[data.yearlyData.length - 1];
            const equityPercent = ((finalYear.equity / data.loanAmount) * 100).toFixed(0);

            document.getElementById('aiObservation').innerHTML = `
                <p><strong>ZenCalcs AI Observation:</strong> You'll start paying more toward principal than interest after year ${crossoverYear}. By the final year, you'll have built ${equityPercent}% equity, with most of your payment going toward ownership rather than interest.</p>
            `;
        }

        async function handleAITool(toolType) {
            const responseArea = document.getElementById('aiResponseArea');
            responseArea.classList.add('active');

            if (!currentMortgageData) {
                responseArea.innerHTML = '<h4>Please calculate a mortgage first</h4>';
                return;
            }

            // Enhanced context-aware prompts with full mortgage data
            const contextData = `
MORTGAGE CONTEXT:
- Home Price: ${formatCurrency(currentMortgageData.homePrice)}
- Down Payment: ${formatCurrency(currentMortgageData.downPayment)} (${((currentMortgageData.downPayment/currentMortgageData.homePrice)*100).toFixed(1)}%)
- Loan Amount: ${formatCurrency(currentMortgageData.loanAmount)}
- Interest Rate: ${currentMortgageData.interestRate}%
- Loan Term: ${currentMortgageData.loanTerm} years
- Monthly Payment: ${formatCurrency(currentMortgageData.monthlyPayment)}
- Total Interest: ${formatCurrency(currentMortgageData.totalInterest)}
- Total Paid: ${formatCurrency(currentMortgageData.totalPaid)}
`;

            const prompts = {
                explain: `${contextData}\nExplain in simple, conversational terms what this mortgage means. Break down the monthly payment and how the payment allocation changes over time. Be specific with numbers.`,
                optimize: `${contextData}\nI want to save money on this mortgage. Suggest 2-3 specific, actionable optimizations with estimated savings. For example: "Increase down payment by $X to save $Y" or "Refinance at X% to save $Y monthly". Be concrete and calculate actual numbers.`,
                compare: `${contextData}\nCompare this ${currentMortgageData.loanTerm}-year mortgage with 15-year and 20-year alternatives. Calculate exact monthly payments and total interest for each option. Show me which option saves the most and by how much.`,
                buyvsrent: `${contextData}\nCompare buying this home versus renting for the same period. Assume monthly rent is ${formatCurrency(currentMortgageData.monthlyPayment * 0.7)}. Consider equity buildup, tax benefits, and opportunity cost. Give me a clear recommendation with numbers.`
            };

            responseArea.innerHTML = '<div class="ai-loading" style="padding: 20px;">Analyzing...</div>';

            try {
                const response = await fetch('/.netlify/functions/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompts[toolType]
                    })
                });

                const result = await response.json();
                const titles = {
                    explain: 'Explanation',
                    optimize: 'Optimization Tips',
                    compare: 'Term Comparison',
                    buyvsrent: 'Buy vs Rent Analysis'
                };
                responseArea.innerHTML = `
                    <h4>${titles[toolType]}</h4>
                    <p>${result.response.replace(/\n/g, '<br><br>')}</p>
                `;
            } catch (error) {
                console.error('AI Tool error:', error);
                responseArea.innerHTML = '<h4>Analysis temporarily unavailable</h4><p>Please try again in a moment.</p>';
            }
        }
    </script>

    <!-- AI Chat Widget -->
    <link rel="stylesheet" href="css/ai-chat.css">
    <script src="js/ai-chat.js"></script>
    <script>
        // Enhanced context-aware chat widget
        // Updates context automatically when user calculates mortgage
        function updateChatContext() {
            if (currentMortgageData && typeof window.setCalculatorContext === 'function') {
                window.setCalculatorContext({
                    calculator: 'Mortgage Calculator',
                    inputs: {
                        homePrice: formatCurrency(currentMortgageData.homePrice),
                        downPayment: formatCurrency(currentMortgageData.downPayment),
                        interestRate: currentMortgageData.interestRate + '%',
                        loanTerm: currentMortgageData.loanTerm + ' years'
                    },
                    results: {
                        monthlyPayment: formatCurrency(currentMortgageData.monthlyPayment),
                        totalInterest: formatCurrency(currentMortgageData.totalInterest),
                        totalPaid: formatCurrency(currentMortgageData.totalPaid),
                        loanAmount: formatCurrency(currentMortgageData.loanAmount)
                    },
                    suggestions: [
                        "How much faster could I pay off this mortgage?",
                        "What if I increased my down payment by $20,000?",
                        "Show me biweekly payment benefits",
                        "Compare with a 15-year mortgage"
                    ]
                });
            }
        }

        // Call this after each calculation
        window.addEventListener('DOMContentLoaded', () => {
            // Initial context (before calculation)
            if (typeof window.setCalculatorContext === 'function') {
                window.setCalculatorContext({
                    calculator: 'Mortgage Calculator',
                    status: 'ready',
                    suggestions: [
                        "How does down payment affect my monthly payment?",
                        "What's a good interest rate for a mortgage?",
                        "Should I get a 15-year or 30-year mortgage?",
                        "How much house can I afford?"
                    ]
                });
            }
        });
    </script>
</body>
</html>
