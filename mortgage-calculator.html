<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <title>Mortgage Calculator with AI Insights - ZenCalcs</title>
    <meta name="description" content="Smart mortgage calculator with AI-powered insights, scenario analysis, and personalized recommendations. Calculate payments and get expert guidance.">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YMJ87N3YC3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-YMJ87N3YC3');
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'display': ['Poppins', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        'brand': {
                            50: '#F0F9FF',
                            100: '#E0F2FE',
                            500: '#2C5F6F',
                            600: '#1E40AF',
                            700: '#1E3A8A'
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; }

        /* Keep existing navbar styles - they work well */
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px 30px; position: sticky; top: 0; z-index: 1000; }
        .nav-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { height: 40px; width: auto; }
        .nav-right { display: flex; gap: 20px; align-items: center; }
        .search-box { display: flex; align-items: center; background: #FFFFFF; border: 1px solid #E5E7EB; border-radius: 8px; padding: 8px 16px; min-width: 250px; transition: all 0.3s ease; }
        .search-box:hover { border-color: #2C5F6F; }
        .search-box:focus-within { border-color: #2C5F6F; box-shadow: 0 0 0 3px rgba(44, 95, 111, 0.1); }
        .search-box svg { width: 20px; height: 20px; color: #6B7280; margin-right: 10px; }
        .search-box input { border: none; outline: none; background: transparent; flex: 1; color: #2D3748; font-size: 0.95em; }
        .search-box input::placeholder { color: #D1D5DB; }
        .hamburger { display: flex; flex-direction: column; gap: 5px; cursor: pointer; padding: 5px; }
        .hamburger span { width: 28px; height: 3px; background: #2C5F6F; border-radius: 3px; transition: all 0.3s ease; }
        .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(8px, 8px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(7px, -7px); }
        .mobile-menu { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.5); z-index: 999; }
        .mobile-menu.active { display: block; }
        .mobile-menu-content { position: fixed; top: 0; right: -350px; width: 320px; height: 100vh; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; padding: 80px 20px 20px 20px; overflow-y: auto; }
        .mobile-menu.active .mobile-menu-content { right: 0; }
        .search-container { padding: 10px 15px 20px; }
        .search-input { width: 100%; padding: 12px 15px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1em; }
        .search-input:focus { outline: none; border-color: #2C5F6F; box-shadow: 0 0 0 3px rgba(44, 95, 111, 0.1); }
        .category-header { font-size: 0.9em; font-weight: 700; color: #6B7280; padding: 15px 20px 10px; text-transform: uppercase; letter-spacing: 1px; }
        .category-divider { height: 1px; background: #E5E7EB; margin: 10px 0; }
        .mobile-menu-item { padding: 14px 20px; margin-bottom: 5px; background: #F8F9FA; border-radius: 8px; font-size: 0.95em; font-weight: 500; color: #2C5F6F; text-decoration: none; display: block; transition: all 0.3s ease; border-left: 4px solid transparent; }
        .mobile-menu-item:hover { background: #E0F2F1; border-left-color: #2C5F6F; transform: translateX(-5px); }

        /* Icon styling */
        .icon { width: 24px; height: 24px; color: currentColor; }
        .icon-lg { width: 64px; height: 64px; }

        /* Loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 3px solid #E5E7EB;
            border-top-color: #2C5F6F;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* Mobile navbar fixes */
        @media (max-width: 768px) {
            .navbar { padding: 10px 15px; }
            .search-box { display: none !important; }
            .logo { height: 32px; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">
                <img src="50F4465B-4D0A-459B-AAD8-B367AAEEF636.jpg" alt="ZenCalcs Logo" class="logo">
            </a>

            <div class="nav-right">
                <div class="search-box" onclick="openSearchInMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" placeholder="Search Calculator" readonly onclick="openSearchInMenu()">
                </div>
                <div class="hamburger" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu" onclick="closeMobileMenu()">
        <div class="mobile-menu-content" onclick="event.stopPropagation()">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search calculators..." onkeyup="filterCalculators()">
            </div>

            <a href="index.html" class="mobile-menu-item" style="background: linear-gradient(135deg, #2C5F6F 0%, #1E40AF 100%); color: white; font-weight: 700; border-left-color: #1E40AF; box-shadow: 0 4px 12px rgba(44, 95, 111, 0.3); margin-bottom: 15px;">⚡ AI Calculator Assistant</a>

            <div class="category-divider"></div>

            <div class="category-header">Financial</div>
            <a href="mortgage-calculator.html" class="mobile-menu-item">Mortgage Calculator</a>
            <a href="loan-calculator.html" class="mobile-menu-item">Loan Calculator</a>
            <a href="auto-loan-calculator.html" class="mobile-menu-item">Auto Loan Calculator</a>
            <a href="compound-interest.html" class="mobile-menu-item">Savings Calculator</a>
            <a href="payment-calculator.html" class="mobile-menu-item">Payment Calculator</a>
            <a href="retirement-calculator.html" class="mobile-menu-item">Retirement Calculator</a>
            <a href="amortization-calculator.html" class="mobile-menu-item">Amortization Calculator</a>
            <a href="investment-calculator.html" class="mobile-menu-item">Investment Calculator</a>
            <a href="inflation-calculator.html" class="mobile-menu-item">Inflation Calculator</a>
            <a href="roi-calculator.html" class="mobile-menu-item">ROI Calculator</a>
            <a href="savings-calculator.html" class="mobile-menu-item">Income Tax Calculator</a>

            <div class="category-divider"></div>

            <div class="category-header">Fitness & Health</div>
            <a href="bmi-calculator.html" class="mobile-menu-item">BMI Calculator</a>
            <a href="calorie-calculator.html" class="mobile-menu-item">Calorie Calculator</a>
            <a href="body-fat-calculator.html" class="mobile-menu-item">Body Fat Calculator</a>
            <a href="bmr-calculator.html" class="mobile-menu-item">BMR Calculator</a>
            <a href="ideal-weight-calculator.html" class="mobile-menu-item">Ideal Weight Calculator</a>
            <a href="pace-calculator.html" class="mobile-menu-item">Pace Calculator</a>
            <a href="pregnancy-calculator.html" class="mobile-menu-item">Pregnancy Calculator</a>
            <a href="due-date-calculator.html" class="mobile-menu-item">Due Date Calculator</a>
            <a href="macro-calculator.html" class="mobile-menu-item">Macro Calculator</a>
            <a href="body-type-calculator.html" class="mobile-menu-item">Body Type Calculator</a>

            <div class="category-divider"></div>

            <div class="category-header">Math</div>
            <a href="scientific-calculator.html" class="mobile-menu-item">Scientific Calculator</a>
            <a href="fraction-calculator.html" class="mobile-menu-item">Fraction Calculator</a>
            <a href="percentage-calculator.html" class="mobile-menu-item">Percentage Calculator</a>
            <a href="random-number-generator.html" class="mobile-menu-item">Random Number Generator</a>
            <a href="triangle-calculator.html" class="mobile-menu-item">Triangle Calculator</a>
            <a href="standard-deviation-calculator.html" class="mobile-menu-item">Standard Deviation Calculator</a>
            <a href="square-root-calculator.html" class="mobile-menu-item">Square Root Calculator</a>
            <a href="exponent-calculator.html" class="mobile-menu-item">Exponent Calculator</a>
            <a href="log-calculator.html" class="mobile-menu-item">Log Calculator</a>
            <a href="algebra-calculator.html" class="mobile-menu-item">Algebra Calculator</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-900 mb-3">Mortgage Calculator with AI Insights</h1>
            <p class="text-lg text-gray-600">Smart mortgage analysis with personalized AI guidance and scenario planning</p>
        </div>

        <!-- Two-Column Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- LEFT PANEL: Input Form -->
            <div class="bg-white rounded-2xl shadow-lg p-8 h-fit lg:sticky lg:top-24">
                <div class="flex items-center gap-3 mb-6">
                    <img src="assets/icons/home.svg" alt="" class="icon text-brand-500">
                    <h2 class="text-2xl font-bold text-gray-900">Mortgage Details</h2>
                </div>
                <p class="text-gray-600 mb-8">Enter your loan information to calculate monthly payments and see AI-powered insights.</p>

                <!-- Input Fields -->
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Home Price ($)</label>
                        <input type="number" id="homePrice" value="300000" min="0"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-800 text-base focus:ring-2 focus:ring-brand-500 focus:border-brand-500 focus:outline-none transition">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Down Payment ($)</label>
                        <input type="number" id="downPayment" value="60000" min="0"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-800 text-base focus:ring-2 focus:ring-brand-500 focus:border-brand-500 focus:outline-none transition">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Interest Rate (%)</label>
                        <input type="number" id="interestRate" value="6.5" step="0.1" min="0" max="30"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-800 text-base focus:ring-2 focus:ring-brand-500 focus:border-brand-500 focus:outline-none transition">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Loan Term (years)</label>
                        <input type="number" id="loanTerm" value="30" min="1" max="40"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-800 text-base focus:ring-2 focus:ring-brand-500 focus:border-brand-500 focus:outline-none transition">
                    </div>

                    <button onclick="calculateMortgage()"
                        class="w-full bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white py-4 rounded-xl text-lg font-bold transition transform hover:-translate-y-0.5 shadow-lg hover:shadow-xl mt-6">
                        Calculate Mortgage
                    </button>
                </div>
            </div>

            <!-- RIGHT PANEL: Results & AI Insights -->
            <div id="resultsContainer" class="min-h-[600px]">
                <!-- Placeholder State (Before Calculation) -->
                <div id="placeholderState" class="bg-gray-50 rounded-2xl shadow-lg p-10 text-center min-h-[600px] flex flex-col items-center justify-center">
                    <img src="assets/icons/calculator.svg" alt="" class="icon-lg text-gray-400 mb-6 opacity-70">

                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Ready when you are!</h3>
                    <p class="text-gray-600 text-base leading-relaxed mb-8 max-w-md">
                        Enter your mortgage details on the left to see comprehensive analysis with charts, payment breakdown, and AI-powered insights instantly.
                    </p>

                    <!-- AI Preview Card -->
                    <div class="bg-white rounded-xl p-6 border-2 border-brand-100 max-w-md">
                        <div class="flex items-start gap-3 mb-3">
                            <img src="assets/icons/sparkles.svg" alt="" class="icon text-brand-500 flex-shrink-0 mt-1">
                            <div class="text-left">
                                <h4 class="font-bold text-gray-800 mb-2">ZenCalcs AI will help you:</h4>
                                <ul class="text-sm text-gray-600 space-y-1.5">
                                    <li class="flex items-start gap-2">
                                        <span class="text-brand-500 font-bold">•</span>
                                        <span>Explain what affects your results</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-brand-500 font-bold">•</span>
                                        <span>Compare different scenarios</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-brand-500 font-bold">•</span>
                                        <span>Provide personalized recommendations</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results State (After Calculation) -->
                <div id="resultsCalculated" class="hidden space-y-6">
                    <!-- What This Means Card -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6 border-2 border-green-200 shadow-md">
                        <div class="flex items-center gap-3 mb-4">
                            <img src="assets/icons/lightbulb.svg" alt="" class="icon text-green-700">
                            <h3 class="text-xl font-bold text-green-800">What This Means</h3>
                        </div>
                        <div id="summaryText" class="text-green-900 text-base leading-relaxed">
                            <div class="flex items-center justify-center py-4">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Mortgage Summary Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <img src="assets/icons/chart.svg" alt="" class="icon text-brand-500">
                            <h3 class="text-xl font-bold text-gray-900">Your Mortgage Summary</h3>
                        </div>

                        <!-- Metrics Grid -->
                        <div id="metricsGrid" class="grid grid-cols-2 gap-4 mb-6"></div>

                        <!-- Chart -->
                        <div class="bg-gray-50 rounded-xl p-6 h-80">
                            <canvas id="mortgageChart"></canvas>
                        </div>
                    </div>

                    <!-- AI Insights Card -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border-2 border-blue-200 shadow-md">
                        <div class="flex items-center gap-3 mb-4">
                            <img src="assets/icons/ai.svg" alt="" class="icon text-blue-700">
                            <h3 class="text-xl font-bold text-blue-900">ZenCalcs AI Insights</h3>
                        </div>
                        <div id="aiInsights" class="text-blue-900 text-base leading-relaxed">
                            <div class="flex items-center justify-center py-4">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Interactive AI Tools -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <img src="assets/icons/sliders.svg" alt="" class="icon text-brand-500">
                            <h3 class="text-xl font-bold text-gray-900">Interactive AI Tools</h3>
                        </div>
                        <p class="text-gray-600 mb-4 text-sm">Get personalized analysis based on your specific mortgage details:</p>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <button onclick="handleAITool('explain')"
                                class="flex items-center gap-3 bg-white border-2 border-gray-200 hover:border-brand-500 hover:bg-brand-50 rounded-xl px-4 py-3 text-left font-semibold text-gray-700 hover:text-brand-700 transition transform hover:-translate-y-0.5">
                                <img src="assets/icons/lightbulb.svg" alt="" class="icon text-brand-500">
                                <span>Explain My Result</span>
                            </button>

                            <button onclick="handleAITool('optimize')"
                                class="flex items-center gap-3 bg-white border-2 border-gray-200 hover:border-brand-500 hover:bg-brand-50 rounded-xl px-4 py-3 text-left font-semibold text-gray-700 hover:text-brand-700 transition transform hover:-translate-y-0.5">
                                <img src="assets/icons/sliders.svg" alt="" class="icon text-brand-500">
                                <span>Optimize My Loan</span>
                            </button>

                            <button onclick="handleAITool('compare')"
                                class="flex items-center gap-3 bg-white border-2 border-gray-200 hover:border-brand-500 hover:bg-brand-50 rounded-xl px-4 py-3 text-left font-semibold text-gray-700 hover:text-brand-700 transition transform hover:-translate-y-0.5">
                                <img src="assets/icons/compare.svg" alt="" class="icon text-brand-500">
                                <span>Compare Term Options</span>
                            </button>

                            <button onclick="handleAITool('buyvsrent')"
                                class="flex items-center gap-3 bg-white border-2 border-gray-200 hover:border-brand-500 hover:bg-brand-50 rounded-xl px-4 py-3 text-left font-semibold text-gray-700 hover:text-brand-700 transition transform hover:-translate-y-0.5">
                                <img src="assets/icons/home.svg" alt="" class="icon text-brand-500">
                                <span>Buy vs Rent Analysis</span>
                            </button>
                        </div>

                        <!-- AI Response Area -->
                        <div id="aiResponseArea" class="hidden mt-6 p-6 bg-gray-50 rounded-xl border-2 border-gray-200">
                            <h4 class="text-lg font-bold text-brand-700 mb-3"></h4>
                            <div class="text-gray-700 leading-relaxed"></div>
                        </div>
                    </div>

                    <!-- Amortization Schedule -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <img src="assets/icons/chart.svg" alt="" class="icon text-brand-500">
                            <h3 class="text-xl font-bold text-gray-900">Amortization Schedule</h3>
                        </div>

                        <div class="overflow-x-auto rounded-xl border border-gray-200">
                            <table id="amortizationTable" class="min-w-full divide-y divide-gray-200"></table>
                        </div>

                        <button id="expandTableBtn" class="hidden w-full mt-4 px-4 py-3 bg-brand-50 hover:bg-brand-100 text-brand-700 font-semibold rounded-xl border-2 border-brand-200 hover:border-brand-300 transition">
                            Show All Years
                        </button>

                        <div id="aiObservation" class="mt-6 p-5 bg-blue-50 rounded-xl border-l-4 border-blue-500">
                            <p class="text-blue-900 leading-relaxed"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let chartInstance = null;
        let currentMortgageData = null;

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            menu.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            menu.classList.remove('active');
            hamburger.classList.remove('active');
        }

        function openSearchInMenu() {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            menu.classList.add('active');
            hamburger.classList.add('active');
            setTimeout(() => {
                document.getElementById('searchInput').focus();
            }, 300);
        }

        function filterCalculators() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('.mobile-menu-item');
            const headers = document.querySelectorAll('.category-header');
            const dividers = document.querySelectorAll('.category-divider');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            if (searchTerm) {
                headers.forEach(header => header.style.display = 'none');
                dividers.forEach(divider => divider.style.display = 'none');
            } else {
                headers.forEach(header => header.style.display = 'block');
                dividers.forEach(divider => divider.style.display = 'block');
            }
        }

        async function calculateMortgage() {
            const homePrice = parseFloat(document.getElementById('homePrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            const rate = parseFloat(document.getElementById('interestRate').value) / 100 / 12;
            const term = parseFloat(document.getElementById('loanTerm').value) * 12;

            const loanAmount = homePrice - downPayment;
            const monthlyPayment = loanAmount * (rate * Math.pow(1 + rate, term)) / (Math.pow(1 + rate, term) - 1);
            const totalPaid = monthlyPayment * term;
            const totalInterest = totalPaid - loanAmount;

            // Calculate amortization schedule
            let balance = loanAmount;
            let yearlyData = [];
            let yearPrincipal = 0;
            let yearInterest = 0;

            for (let i = 1; i <= term; i++) {
                const interestPayment = balance * rate;
                const principalPayment = monthlyPayment - interestPayment;
                balance -= principalPayment;

                yearPrincipal += principalPayment;
                yearInterest += interestPayment;

                if (i % 12 === 0 || i === term) {
                    yearlyData.push({
                        year: Math.ceil(i / 12),
                        principal: yearPrincipal,
                        interest: yearInterest,
                        balance: Math.max(0, balance),
                        equity: loanAmount - balance
                    });
                    yearPrincipal = 0;
                    yearInterest = 0;
                }
            }

            // Store current data
            currentMortgageData = {
                homePrice,
                downPayment,
                interestRate: parseFloat(document.getElementById('interestRate').value),
                loanTerm: parseFloat(document.getElementById('loanTerm').value),
                monthlyPayment,
                totalInterest,
                totalPaid,
                loanAmount,
                yearlyData
            };

            // Display results
            displayResults(currentMortgageData);

            // Get AI insights
            await getAIInsights(currentMortgageData);

            // Update chat widget context
            updateChatContext();
        }

        function displayResults(data) {
            // Hide placeholder, show results
            document.getElementById('placeholderState').classList.add('hidden');
            document.getElementById('resultsCalculated').classList.remove('hidden');

            // Generate "What This Means" summary
            generateWhatThisMeans(data);

            // Metrics Grid
            document.getElementById('metricsGrid').innerHTML = `
                <div class="bg-gradient-to-br from-brand-50 to-brand-100 p-4 rounded-xl border-l-4 border-brand-500">
                    <div class="text-xs sm:text-sm font-semibold text-brand-700 mb-1.5 whitespace-nowrap">Monthly Payment</div>
                    <div class="text-lg sm:text-xl lg:text-2xl font-bold text-brand-900 break-words">${formatCurrency(data.monthlyPayment)}</div>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-orange-50 p-4 rounded-xl border-l-4 border-red-400">
                    <div class="text-xs sm:text-sm font-semibold text-red-700 mb-1.5 whitespace-nowrap">Total Interest</div>
                    <div class="text-lg sm:text-xl lg:text-2xl font-bold text-red-900 break-words">${formatCurrency(data.totalInterest)}</div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-xl border-l-4 border-purple-400">
                    <div class="text-xs sm:text-sm font-semibold text-purple-700 mb-1.5 whitespace-nowrap">Total Paid</div>
                    <div class="text-lg sm:text-xl lg:text-2xl font-bold text-purple-900 break-words">${formatCurrency(data.totalPaid)}</div>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-xl border-l-4 border-blue-400">
                    <div class="text-xs sm:text-sm font-semibold text-blue-700 mb-1.5 whitespace-nowrap">Loan Amount</div>
                    <div class="text-lg sm:text-xl lg:text-2xl font-bold text-blue-900 break-words">${formatCurrency(data.loanAmount)}</div>
                </div>
            `;

            // Create chart
            createChart(data.yearlyData);

            // Amortization table - show first 5 rows initially
            const tableRows = data.yearlyData.map((row, idx) => `
                <tr class="hover:bg-gray-50 transition ${idx >= 5 ? 'hidden amortization-extra-row' : ''}">
                    <td class="px-4 sm:px-6 py-3 sm:py-4 font-bold text-gray-900 text-sm">Year ${row.year}</td>
                    <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-700 text-sm">${formatCurrency(row.principal)}</td>
                    <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-700 text-sm">${formatCurrency(row.interest)}</td>
                    <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-700 text-sm">${formatCurrency(row.principal + row.interest)}</td>
                    <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-700 text-sm">${formatCurrency(row.balance)}</td>
                    <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-700 text-sm">${formatCurrency(row.equity)}</td>
                </tr>
            `).join('');

            document.getElementById('amortizationTable').innerHTML = `
                <thead class="bg-brand-500 text-white">
                    <tr>
                        <th class="px-4 sm:px-6 py-3 sm:py-4 text-left text-xs sm:text-sm font-bold">Year</th>
                        <th class="px-4 sm:px-6 py-3 sm:py-4 text-left text-xs sm:text-sm font-bold">Principal Paid</th>
                        <th class="px-4 sm:px-6 py-3 sm:py-4 text-left text-xs sm:text-sm font-bold">Interest Paid</th>
                        <th class="px-4 sm:px-6 py-3 sm:py-4 text-left text-xs sm:text-sm font-bold">Total Paid</th>
                        <th class="px-4 sm:px-6 py-3 sm:py-4 text-left text-xs sm:text-sm font-bold">Remaining</th>
                        <th class="px-4 sm:px-6 py-3 sm:py-4 text-left text-xs sm:text-sm font-bold">Equity</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${tableRows}
                </tbody>
            `;

            // Add expand/collapse button if more than 5 rows
            const expandBtn = document.getElementById('expandTableBtn');
            if (data.yearlyData.length > 5) {
                expandBtn.classList.remove('hidden');
                expandBtn.onclick = function() {
                    const extraRows = document.querySelectorAll('.amortization-extra-row');
                    const isExpanded = extraRows[0].classList.contains('hidden');

                    extraRows.forEach(row => {
                        if (isExpanded) {
                            row.classList.remove('hidden');
                        } else {
                            row.classList.add('hidden');
                        }
                    });

                    this.textContent = isExpanded ? 'Show Less' : `Show All ${data.yearlyData.length} Years`;
                };
                expandBtn.textContent = `Show All ${data.yearlyData.length} Years`;
            } else {
                expandBtn.classList.add('hidden');
            }

            // AI Observation
            generateAIObservation(data);
        }

        function createChart(yearlyData) {
            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = document.getElementById('mortgageChart');
            chartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: yearlyData.map(d => `Year ${d.year}`),
                    datasets: [
                        {
                            label: 'Principal',
                            data: yearlyData.map(d => d.principal),
                            backgroundColor: '#2C5F6F',
                            borderRadius: 6
                        },
                        {
                            label: 'Interest',
                            data: yearlyData.map(d => d.interest),
                            backgroundColor: '#5FA8D3',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: {
                            display: true,
                            text: 'Principal vs Interest Payments',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => context.dataset.label + ': ' + formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: (value) => '$' + (value / 1000).toFixed(0) + 'K'
                            }
                        }
                    }
                }
            });
        }

        async function getAIInsights(data) {
            const insightsDiv = document.getElementById('aiInsights');
            insightsDiv.innerHTML = '<div class="flex items-center justify-center py-4"><div class="spinner"></div></div>';

            try {
                const response = await fetch('/.netlify/functions/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Analyze this mortgage and provide 2-3 paragraphs of insights:

Home Price: ${formatCurrency(data.homePrice)}
Down Payment: ${formatCurrency(data.downPayment)} (${((data.downPayment/data.homePrice)*100).toFixed(1)}%)
Loan Amount: ${formatCurrency(data.loanAmount)}
Interest Rate: ${data.interestRate}%
Loan Term: ${data.loanTerm} years
Monthly Payment: ${formatCurrency(data.monthlyPayment)}
Total Interest: ${formatCurrency(data.totalInterest)}
Total Paid: ${formatCurrency(data.totalPaid)}

Explain what these numbers mean, highlight the interest proportion, and suggest one optimization.`
                    })
                });

                const result = await response.json();
                insightsDiv.innerHTML = `<div class="prose prose-blue max-w-none">${result.response.replace(/\n\n/g, '</p><p class="mt-4">')}</p></div>`;
            } catch (error) {
                console.error('AI Insights error:', error);
                insightsDiv.innerHTML = `<p>Your monthly payment of ${formatCurrency(data.monthlyPayment)} includes both principal and interest. Over ${data.loanTerm} years, you'll pay ${formatCurrency(data.totalInterest)} in interest (${((data.totalInterest/data.loanAmount)*100).toFixed(0)}% of the loan amount).</p><p class="mt-4">Consider increasing your down payment or choosing a shorter term to reduce total interest costs.</p>`;
            }
        }

        async function generateWhatThisMeans(data) {
            const summaryDiv = document.getElementById('summaryText');
            summaryDiv.innerHTML = '<div class="flex items-center justify-center py-4"><div class="spinner"></div></div>';

            try {
                const response = await fetch('/.netlify/functions/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Generate a concise 2-3 sentence plain-language summary of this mortgage:

Monthly Payment: ${formatCurrency(data.monthlyPayment)}
Total Interest: ${formatCurrency(data.totalInterest)}
Loan Term: ${data.loanTerm} years

Make it conversational and focus on what the user should know most. Start directly with the insight, no greeting.`
                    })
                });

                const result = await response.json();
                summaryDiv.innerHTML = `<p>${result.response}</p>`;
            } catch (error) {
                console.error('What This Means error:', error);
                const interestPercent = ((data.totalInterest / data.loanAmount) * 100).toFixed(0);
                summaryDiv.innerHTML = `<p>Your ${formatCurrency(data.monthlyPayment)} monthly payment stays the same for ${data.loanTerm} years. You'll pay ${formatCurrency(data.totalInterest)} in interest (${interestPercent}% of your loan amount), which is typical for a ${data.loanTerm}-year mortgage. Consider making extra payments to reduce this cost.</p>`;
            }
        }

        function generateAIObservation(data) {
            let crossoverYear = data.yearlyData.length;
            for (let i = 0; i < data.yearlyData.length; i++) {
                if (data.yearlyData[i].principal > data.yearlyData[i].interest) {
                    crossoverYear = i + 1;
                    break;
                }
            }

            const finalYear = data.yearlyData[data.yearlyData.length - 1];
            const equityPercent = ((finalYear.equity / data.loanAmount) * 100).toFixed(0);

            document.getElementById('aiObservation').innerHTML = `
                <p class="font-semibold text-blue-900"><img src="assets/icons/ai.svg" alt="" class="icon text-blue-700 inline mr-2">ZenCalcs AI Observation:</p>
                <p class="mt-2 text-blue-800">You'll start paying more toward principal than interest after year ${crossoverYear}. By the final year, you'll have built ${equityPercent}% equity, with most of your payment going toward ownership rather than interest.</p>
            `;
        }

        async function handleAITool(toolType) {
            const responseArea = document.getElementById('aiResponseArea');
            responseArea.classList.remove('hidden');

            if (!currentMortgageData) {
                responseArea.innerHTML = '<h4 class="text-lg font-bold text-red-600">Please calculate a mortgage first</h4>';
                return;
            }

            const contextData = `
MORTGAGE CONTEXT:
- Home Price: ${formatCurrency(currentMortgageData.homePrice)}
- Down Payment: ${formatCurrency(currentMortgageData.downPayment)} (${((currentMortgageData.downPayment/currentMortgageData.homePrice)*100).toFixed(1)}%)
- Loan Amount: ${formatCurrency(currentMortgageData.loanAmount)}
- Interest Rate: ${currentMortgageData.interestRate}%
- Loan Term: ${currentMortgageData.loanTerm} years
- Monthly Payment: ${formatCurrency(currentMortgageData.monthlyPayment)}
- Total Interest: ${formatCurrency(currentMortgageData.totalInterest)}
- Total Paid: ${formatCurrency(currentMortgageData.totalPaid)}
`;

            const prompts = {
                explain: `${contextData}\nExplain in simple, conversational terms what this mortgage means. Break down the monthly payment and how the payment allocation changes over time. Be specific with numbers.`,
                optimize: `${contextData}\nI want to save money on this mortgage. Suggest 2-3 specific, actionable optimizations with estimated savings. For example: "Increase down payment by $X to save $Y" or "Refinance at X% to save $Y monthly". Be concrete and calculate actual numbers.`,
                compare: `${contextData}\nCompare this ${currentMortgageData.loanTerm}-year mortgage with 15-year and 20-year alternatives. Calculate exact monthly payments and total interest for each option. Show me which option saves the most and by how much.`,
                buyvsrent: `${contextData}\nCompare buying this home versus renting for the same period. Assume monthly rent is ${formatCurrency(currentMortgageData.monthlyPayment * 0.7)}. Consider equity buildup, tax benefits, and opportunity cost. Give me a clear recommendation with numbers.`
            };

            const titles = {
                explain: 'Explanation',
                optimize: 'Optimization Tips',
                compare: 'Term Comparison',
                buyvsrent: 'Buy vs Rent Analysis'
            };

            responseArea.innerHTML = '<div class="flex items-center justify-center py-4"><div class="spinner"></div></div>';

            try {
                const response = await fetch('/.netlify/functions/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompts[toolType]
                    })
                });

                const result = await response.json();
                responseArea.innerHTML = `
                    <h4 class="text-lg font-bold text-brand-700 mb-3">${titles[toolType]}</h4>
                    <div class="text-gray-700 leading-relaxed prose prose-sm max-w-none">${result.response.replace(/\n\n/g, '</p><p class="mt-3">')}</p></div>
                `;
            } catch (error) {
                console.error('AI Tool error:', error);
                responseArea.innerHTML = '<h4 class="text-lg font-bold text-red-600">Analysis temporarily unavailable</h4><p class="text-gray-600 mt-2">Please try again in a moment.</p>';
            }
        }

        function updateChatContext() {
            if (currentMortgageData && typeof window.setCalculatorContext === 'function') {
                window.setCalculatorContext({
                    calculator: 'Mortgage Calculator',
                    inputs: {
                        homePrice: formatCurrency(currentMortgageData.homePrice),
                        downPayment: formatCurrency(currentMortgageData.downPayment),
                        interestRate: currentMortgageData.interestRate + '%',
                        loanTerm: currentMortgageData.loanTerm + ' years'
                    },
                    results: {
                        monthlyPayment: formatCurrency(currentMortgageData.monthlyPayment),
                        totalInterest: formatCurrency(currentMortgageData.totalInterest),
                        totalPaid: formatCurrency(currentMortgageData.totalPaid),
                        loanAmount: formatCurrency(currentMortgageData.loanAmount)
                    },
                    suggestions: [
                        "How much faster could I pay off this mortgage?",
                        "What if I increased my down payment by $20,000?",
                        "Show me biweekly payment benefits",
                        "Compare with a 15-year mortgage"
                    ]
                });
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (typeof window.setCalculatorContext === 'function') {
                window.setCalculatorContext({
                    calculator: 'Mortgage Calculator',
                    status: 'ready',
                    suggestions: [
                        "How does down payment affect my monthly payment?",
                        "What's a good interest rate for a mortgage?",
                        "Should I get a 15-year or 30-year mortgage?",
                        "How much house can I afford?"
                    ]
                });
            }
        });
    </script>
</body>
</html>
